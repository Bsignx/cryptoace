import Link from "next/link";
import Image from "next/image";
import { ModeToggle } from "@/components/mode-toggle";
import { HeaderLinks } from "@/app/_header/header-links";
import { Suspense } from "react";
import { getCurrentUser } from "@/lib/session";
import { Button } from "@/components/ui/button";
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu";
import { Avatar, AvatarFallback, AvatarImage } from "@/components/ui/avatar";
import { Settings2Icon } from "lucide-react";
import { HeaderActionsFallback } from "@/app/_header/header-actions-fallback";
import { SignOutItem } from "@/app/_header/sign-out-item";
import {
  getUnreadNotificationsForUserUseCase,
  getUserProfileUseCase,
} from "@/use-cases/users";
import { getProfileImageFullUrl } from "@/app/dashboard/settings/profile/profile-image";
import { Notifications } from "./notifications";
import { MenuButton } from "./menu-button";

export async function Header() {
  const user = await getCurrentUser();

  return (
    <div className="border-b py-4">
      <div className="container mx-auto flex justify-between items-center">
        <div className="flex gap-12 items-center">
          <Link href="/" className="flex gap-2 items-center text-xl">
            <Logo />
          </Link>

          <HeaderLinks isAuthenticated={!!user} />
        </div>

        <div className="flex items-center justify-between gap-5">
          <Suspense fallback={<HeaderActionsFallback />}>
            <HeaderActions />
          </Suspense>
        </div>
      </div>
    </div>
  );
}

const Logo = () => (
  <svg
    aria-label="Cryptoace Logo"
    width="160"
    height="76"
    viewBox="0 0 420 76"
    className="fill-current text-gray-900 dark:text-white"
    xmlns="http://www.w3.org/2000/svg"
  >
    <path d="M16.4981 17.6442C12.8866 17.6442 10.4242 17.6442 9.27504 17.8083C7.7976 17.9725 6.73056 18.465 5.99184 19.1216C5.25312 19.7783 4.67856 21.0094 4.26816 22.7331C4.104 23.7181 3.77568 25.8522 3.2832 29.1354C3.20112 29.792 2.8728 32.2544 2.21616 36.6868C1.55952 41.037 1.14912 44.4023 0.820801 46.7005C0.328321 49.9837 0.08208 52.1178 0 53.2669C0 54.7444 0.164162 55.8114 0.574562 56.468C1.06704 57.1247 1.88784 57.6172 3.03696 57.9455C4.18608 58.1097 6.73056 58.2738 10.8346 58.2738H28.8922C32.3396 58.2738 34.6378 58.1917 35.7048 58.1096C37.3464 57.9455 38.5776 57.5351 39.3164 56.9605C40.1372 56.3039 40.7117 55.1548 41.04 53.6773C41.3684 52.5282 41.6967 50.23 42.1892 46.7005H30.5338H12.4762L14.5282 32.1723C14.6923 31.3515 14.7744 30.777 14.7744 30.5307C14.9386 30.0383 15.1027 29.71 15.2669 29.5458C15.4311 29.3816 15.6773 29.2995 16.0056 29.2995C16.3339 29.1354 17.1547 29.1354 18.3038 29.1354H32.9962C36.1152 29.1354 38.1672 29.0533 39.2343 29.0533C41.2042 28.8892 42.6816 28.3967 43.5024 27.6579C44.2412 27.0013 44.8157 25.8522 45.144 24.2927C45.4723 23.1435 45.8007 20.9274 46.2932 17.6442H34.6378L16.4981 17.6442Z" />
    <path d="M50.7255 29.1354L46.6215 58.2738C51.0538 58.2738 53.8445 58.1096 54.9936 57.8634C56.1427 57.5351 56.9635 57.0426 57.5381 56.386C58.1947 55.6473 58.6051 54.4981 58.9335 53.0207C59.1797 51.9537 59.508 49.9017 59.9184 46.7826L61.8883 32.5828C62.0525 31.5157 62.2167 30.8591 62.2987 30.5307C62.4629 30.0383 62.6271 29.71 62.9554 29.5458C63.2016 29.3816 63.5299 29.2175 63.9403 29.2175C64.3507 29.1354 65.1715 29.1354 66.4027 29.1354H80.3564C83.8037 29.1354 86.0199 29.0533 87.0869 28.9712C88.8106 28.8071 90.0418 28.3967 90.7805 27.74C91.6013 27.0834 92.1759 25.9343 92.5863 24.3748C92.9146 23.2256 93.2429 21.0095 93.7354 17.6442H64.0224C60.0826 17.5621 57.5381 17.6442 56.389 17.8904C55.0757 18.0546 54.0086 18.5471 53.352 19.2858C52.6954 19.9424 52.1208 21.1736 51.7104 22.9794C51.5462 23.9643 51.2179 26.0163 50.7255 29.1354Z" />
    <path d="M98.8244 17.5621L97.1828 29.0533L94.7204 46.7826C94.31 49.9016 94.0638 52.0357 94.0638 53.1028C93.9817 54.7444 94.1459 55.8935 94.6383 56.6322C95.1308 57.2888 96.1979 57.7813 97.6753 58.0276C98.8244 58.1917 101.205 58.2738 104.816 58.2738H122.874C122.71 59.5871 122.628 60.49 122.463 60.9824C122.381 61.6391 122.217 62.1315 122.053 62.5419C121.807 62.9523 121.314 63.2807 120.658 63.4448C120.165 63.5269 119.18 63.609 117.539 63.609H104.078C101.123 63.609 99.1528 63.609 98.1678 63.7731C96.4441 63.9373 95.1308 64.3477 94.31 65.0043C93.4892 65.661 92.7505 66.9743 92.1759 68.8621C91.9297 69.8471 91.4372 71.9812 90.7806 75.1823H102.436H120.494C123.859 75.1823 126.075 75.1002 127.142 75.0181C129.112 74.7719 130.425 74.2794 131.164 73.4586C131.821 72.7199 132.395 71.5708 132.724 70.0933C133.052 68.9442 133.38 66.8101 133.791 63.609L134.529 58.2738L136.171 46.7826L138.633 29.0533C138.962 26.9192 139.126 25.4418 139.208 24.621C139.454 22.1586 139.372 20.4349 138.962 19.6141C138.551 18.6291 137.402 17.9725 135.596 17.7262C134.529 17.5621 132.231 17.5621 128.619 17.5621L126.978 29.0533L124.926 43.8277C124.844 44.4023 124.762 44.8127 124.68 45.141C124.598 45.4693 124.515 45.7155 124.433 45.8797C124.269 46.208 124.023 46.4543 123.613 46.6184C123.366 46.7005 122.628 46.7826 121.396 46.7826H106.458L108.92 29.0533C109.413 25.2776 109.659 23.0614 109.659 22.2406C109.741 20.517 109.413 19.3678 108.756 18.7933C108.099 18.0546 106.54 17.6442 104.16 17.5621C103.257 17.5621 101.451 17.5621 98.8244 17.5621Z" />
    <path d="M151.356 63.4448L152.094 58.2738H170.152C174.01 58.2738 176.554 58.1917 177.703 58.0276C179.099 57.7813 180.084 57.2888 180.74 56.6322C181.397 55.9756 181.972 54.9085 182.3 53.4311C182.628 52.364 182.956 50.1479 183.367 46.7826C183.367 46.7826 184.188 40.8728 185.829 29.2174C186.24 26.5909 186.486 24.7851 186.568 23.8822C186.814 21.4198 186.568 19.8603 185.829 19.0395C185.337 18.465 184.516 18.1366 183.367 17.9725C182.3 17.7262 179.755 17.6442 175.815 17.6442H157.758C153.982 17.6442 151.52 17.7263 150.289 17.8904C149.139 18.0546 148.155 18.3829 147.498 18.8754C146.677 19.4499 146.02 20.599 145.528 22.3227C145.282 23.3898 144.953 25.688 144.461 29.2175L144.051 32.2544L138.059 75.1002C141.67 75.1002 143.968 75.0182 145.035 74.854C146.677 74.6898 147.826 74.2794 148.483 73.6228C149.222 72.9661 149.796 71.8991 150.124 70.4216C150.453 69.2725 150.863 66.9743 151.356 63.4448ZM168.921 46.7826C168.757 46.7826 168.592 46.7826 168.346 46.7826H153.736V46.7005L155.706 32.2544C155.87 31.4336 156.034 30.859 156.116 30.6128C156.28 30.1203 156.445 29.792 156.609 29.6279C156.773 29.4637 157.019 29.2995 157.347 29.2995C157.676 29.2175 158.415 29.2175 159.482 29.2175H174.174L172.122 43.7456C172.04 44.5664 171.958 45.0589 171.876 45.3872C171.794 45.7155 171.629 46.0439 171.465 46.2901C171.301 46.4543 171.055 46.5363 170.644 46.7005C170.316 46.7005 169.742 46.7826 168.921 46.7826Z" />
    <path d="M206.267 0.817749L203.969 17.6441C200.44 17.6441 198.141 17.6442 196.992 17.8083C195.351 17.9725 194.201 18.465 193.381 19.1216C192.642 19.8603 192.067 21.2557 191.575 23.3077C191.411 24.2926 191.082 26.2625 190.672 29.2174H202.327L201.917 32.1723L200.275 43.7456L199.865 46.7826C199.372 49.8195 199.044 51.8715 198.88 52.9386C198.798 54.5802 198.962 55.8114 199.372 56.5501C199.947 57.3709 201.26 57.9455 203.394 58.1917C204.544 58.1917 206.678 58.2738 209.879 58.2738H216.363C219.892 58.2738 222.191 58.1917 223.258 58.1096C224.899 57.8634 226.131 57.453 226.869 56.7963C227.526 56.1397 228.101 54.9906 228.511 53.5131C228.839 52.364 229.168 50.1479 229.578 46.7826H217.923H211.52L211.931 43.7456L213.572 32.1723L213.983 29.2174H220.385C223.832 29.2174 226.049 29.1354 227.116 29.0533C228.757 28.807 229.988 28.3966 230.727 27.9042C231.466 27.2475 232.04 26.2626 232.451 24.9493C232.779 23.8002 233.189 21.4198 233.682 17.6441H222.027H215.624L216.363 12.391C216.856 9.51824 217.102 7.71247 217.102 6.97375C217.348 5.16799 217.266 3.85472 216.938 3.03392C216.445 1.8848 215.132 1.22816 212.834 1.064C211.602 0.899835 209.386 0.817749 206.267 0.817749Z" />
    <path d="M317.65 17.5621C317.322 17.5621 316.583 17.5621 315.598 17.5621H285.885C285.885 20.599 285.967 22.651 285.967 23.7181C286.131 25.5238 286.459 26.755 286.952 27.4938C287.526 28.2325 288.511 28.725 289.989 28.9712C290.974 29.0533 293.026 29.1354 295.981 29.1354H311.986H314.038C313.956 30.0382 313.874 30.6128 313.792 30.9411C313.792 31.2695 313.71 31.5157 313.546 31.6798C313.382 31.844 313.135 32.0082 312.807 32.0902C312.643 32.0902 312.15 32.1723 311.494 32.1723H295.488C291.713 32.1723 289.168 32.2544 288.019 32.4186C286.624 32.5827 285.557 33.0752 284.818 33.8139C284.161 34.4706 283.587 35.7838 283.176 37.7538C283.012 38.7387 282.684 40.7086 282.273 43.6635L281.781 46.7005C281.37 49.9837 281.124 52.1999 281.042 53.349C281.042 54.9085 281.206 56.0576 281.699 56.7143C282.191 57.2888 283.012 57.6992 284.161 57.9455C285.31 58.1096 287.855 58.2738 291.795 58.2738H309.606C313.71 58.2738 316.337 58.1096 317.486 57.9455C318.635 57.6992 319.538 57.3709 320.194 56.8784C320.933 56.3039 321.508 55.401 321.836 54.2519C322.246 53.1027 322.739 50.6404 323.231 46.7005L324.38 38.3283L325.694 29.1354C326.104 26.1805 326.35 24.2106 326.35 23.2256C326.515 20.8453 326.186 19.2857 325.201 18.6291C324.709 18.2187 323.888 17.9725 322.739 17.8083C321.754 17.6441 320.03 17.5621 317.65 17.5621ZM295.817 43.6635H309.934H311.986C311.904 44.5664 311.822 45.141 311.74 45.4693C311.658 45.7976 311.576 46.1259 311.412 46.2901C311.33 46.4543 311.166 46.5363 310.837 46.6184C310.673 46.6184 310.181 46.7005 309.524 46.7005H295.406H293.436C293.6 46.0439 293.682 45.5514 293.682 45.3051C293.765 44.6485 293.847 44.2381 294.011 44.0739C294.175 43.9098 294.339 43.7456 294.585 43.7456C294.749 43.6635 295.16 43.6635 295.817 43.6635Z" />
    <path d="M344.49 17.6442C340.879 17.6442 338.416 17.6442 337.267 17.8083C335.79 17.9725 334.722 18.465 333.984 19.1216C333.245 19.7783 332.671 21.0094 332.26 22.7331C332.096 23.7181 331.768 25.8522 331.275 29.1354C331.193 29.792 330.865 32.2544 330.208 36.6868C329.551 41.037 329.141 44.4023 328.813 46.7005C328.32 49.9837 328.074 52.1178 327.992 53.2669C327.992 54.7444 328.156 55.8114 328.566 56.468C329.059 57.1247 329.88 57.6172 331.029 57.9455C332.178 58.1097 334.722 58.2738 338.827 58.2738H356.884C360.331 58.2738 362.63 58.1917 363.697 58.1096C365.338 57.9455 366.57 57.5351 367.308 56.9605C368.129 56.3039 368.704 55.1548 369.032 53.6773C369.36 52.5282 369.689 50.23 370.181 46.7005H358.526H340.468L342.52 32.1723C342.684 31.3515 342.766 30.777 342.766 30.5307C342.931 30.0383 343.095 29.71 343.259 29.5458C343.423 29.3816 343.669 29.2995 343.998 29.2995C344.326 29.1354 345.147 29.1354 346.296 29.1354H360.988C364.107 29.1354 366.159 29.0533 367.226 29.0533C369.196 28.8892 370.674 28.3967 371.494 27.6579C372.233 27.0013 372.808 25.8522 373.136 24.2927C373.464 23.1435 373.793 20.9274 374.285 17.6442H362.63L344.49 17.6442Z" />
    <path d="M391.358 17.5621C387.582 17.5621 385.12 17.6442 383.971 17.8083C382.493 17.9725 381.344 18.465 380.523 19.2037C379.785 19.8603 379.21 21.2557 378.8 23.2256C378.635 24.2106 378.307 26.0984 377.815 29.0533L375.352 46.6184C374.942 49.9016 374.696 52.0357 374.613 53.1848C374.613 54.5802 374.778 55.6472 375.106 56.3039C375.598 57.0426 376.419 57.5351 377.568 57.8634C378.717 58.1096 381.262 58.1917 385.366 58.1917H415.161C415.161 54.9085 415.161 52.7744 414.997 51.7895C414.915 49.9837 414.586 48.8346 413.93 48.1779C413.437 47.5213 412.534 47.1109 411.221 46.9467C410.318 46.7826 408.266 46.7005 405.065 46.7005H389.06H387.008C387.172 45.7976 387.254 45.2231 387.254 44.9768C387.336 44.4843 387.418 44.156 387.582 43.9919C387.746 43.8277 387.992 43.7456 388.239 43.7456C388.485 43.6635 388.895 43.6635 389.47 43.6635H405.558C409.169 43.6635 411.467 43.5815 412.617 43.4173C414.258 43.2532 415.407 42.7607 416.146 42.104C416.803 41.3653 417.377 40.2162 417.705 38.6567C418.034 37.5896 418.362 35.4555 418.773 32.1723L419.265 29.0533C419.593 26.4267 419.84 24.7031 419.922 23.8002C420.168 21.0915 419.84 19.3679 418.855 18.6291C418.198 18.1367 416.967 17.8083 415.161 17.6442C414.176 17.5621 412.206 17.5621 409.251 17.5621L391.358 17.5621ZM391.522 29.1354H405.64H407.528C407.445 30.0382 407.363 30.6949 407.281 31.0232C407.281 31.3515 407.199 31.5157 407.035 31.6798C406.871 31.844 406.543 32.0082 406.05 32.0902C405.886 32.0902 405.64 32.0902 405.229 32.0902H391.112H389.06C389.224 31.1053 389.306 30.5307 389.306 30.2845C389.47 29.9562 389.552 29.7099 389.634 29.5458C389.798 29.3816 389.962 29.2174 390.127 29.2174C390.291 29.1354 390.783 29.1354 391.522 29.1354Z" />
    <path d="M238.032 24.211C238.525 21.666 239.181 20.024 240.002 19.204C240.741 18.383 241.89 17.89 243.532 17.726C244.681 17.562 247.061 17.562 250.59 17.562H268.648C272.916 17.562 275.625 17.644 276.774 17.972C277.759 18.137 278.498 18.629 278.908 19.286C279.401 19.942 279.565 21.174 279.483 22.815C279.483 23.8 279.236 25.934 278.744 29.053L276.282 46.618C275.871 49.573 275.543 51.543 275.297 52.61C274.968 54.088 274.558 55.237 274.065 55.976C273.409 56.96 272.342 57.535 270.782 57.863C269.633 58.028 267.089 58.192 262.985 58.192H244.927C240.987 58.192 238.443 58.028 237.293 57.863C235.98 57.617 235.159 57.125 234.667 56.386C234.257 55.565 234.092 54.416 234.092 52.774C234.174 51.707 234.421 49.655 234.831 46.618C235.159 44.895 235.98 39.067 237.293 29.053C237.622 26.673 237.868 25.031 238.032 24.211ZM251.847 24.7111C251.082 25.8363 250.463 27.2623 249.988 28.9866C249.512 30.7109 249.43 32.429 249.74 34.1418C249.782 34.3897 249.864 34.8175 249.988 35.4264C250.112 36.0374 250.194 36.4812 250.236 36.7594C250.277 37.0376 250.339 37.4449 250.422 37.9834C250.504 38.5197 250.54 38.9275 250.53 39.2057C250.52 39.486 250.509 39.831 250.5 40.244C250.488 40.6575 250.427 40.9824 250.313 41.2201C250.2 41.4582 250.059 41.704 249.896 41.9626C249.729 42.2224 249.512 42.4317 249.244 42.5973C248.976 42.7628 248.656 42.8878 248.284 42.9702C247.5 43.1759 246.808 43.0431 246.209 42.5674C245.611 42.0908 245.192 41.4581 244.955 40.662C244.717 39.8674 244.562 39.0266 244.49 38.137C244.417 37.2495 244.526 36.4754 244.816 35.8141C243.741 36.7659 242.88 37.8084 242.228 38.9438C241.578 40.0793 241.176 41.184 241.02 42.2568C240.866 43.332 240.789 44.2093 240.789 44.8911C240.789 45.5722 240.84 46.2216 240.944 46.8428C241.129 47.9984 241.583 49.2326 242.306 50.5434C243.029 51.8539 244.113 52.975 245.559 53.9055C246.198 54.3387 246.859 54.5038 247.541 54.3989C248.223 54.2965 248.862 54.0547 249.462 53.6716C250.06 53.2909 250.649 52.7799 251.228 52.1391C251.805 51.4998 252.3 50.8643 252.713 50.2332C253.127 49.6038 253.488 48.979 253.798 48.3598C254.459 46.9969 254.861 45.0932 255.006 42.6448C255.15 40.1989 255.016 38.5714 254.603 37.7666C256.235 39.4183 257.493 41.1123 258.382 42.846C259.27 44.581 259.539 46.4827 259.188 48.5459C259.084 49.2269 258.872 49.9444 258.553 50.6992C258.232 51.4535 257.845 52.2841 257.391 53.1917C257.184 53.5851 257.035 53.8851 256.941 54.0912C256.849 54.2969 256.725 54.5649 256.57 54.896C256.415 55.2262 256.322 55.468 256.291 55.6233C256.26 55.7786 256.229 55.9745 256.198 56.2125C256.167 56.4502 256.193 56.61 256.276 56.6928C256.358 56.7751 256.471 56.8747 256.616 56.987C256.761 57.1001 256.962 57.1525 257.22 57.1423C257.478 57.1329 257.793 57.1062 258.165 57.0636C258.536 57.0238 258.971 56.9411 259.466 56.8161C260.643 56.4047 261.582 56.0535 262.285 55.7634C262.987 55.4749 263.891 55.0152 264.995 54.3862C266.1 53.7552 266.998 53.0958 267.69 52.4042C268.381 51.7125 269.058 50.7991 269.719 49.6616C270.38 48.5258 270.865 47.2678 271.175 45.8824C271.959 42.3314 271.5 38.8062 269.797 35.3051C268.094 31.8041 265.547 28.9284 262.161 26.6779C262.615 27.5872 263.06 28.9181 263.493 30.6748C264.298 33.9578 263.968 35.5469 262.502 35.444C262.191 35.4035 261.852 35.3109 261.48 35.1658C259.848 34.484 258.604 33.4514 257.747 32.068C256.89 30.6846 256.435 28.8718 256.384 26.6312C256.332 24.3911 256.834 21.7329 257.886 18.6556C257.618 18.8207 257.267 19.0629 256.834 19.3833C256.4 19.7034 255.651 20.3893 254.588 21.442C253.524 22.4967 252.61 23.5859 251.847 24.7111Z" />
  </svg>
);

async function ProfileAvatar({ userId }: { userId: number }) {
  const profile = await getUserProfileUseCase(userId);

  return (
    <Avatar>
      <AvatarImage src={getProfileImageFullUrl(profile)} />
      <AvatarFallback>
        {profile.displayName?.substring(0, 2).toUpperCase() ?? "AA"}
      </AvatarFallback>
    </Avatar>
  );
}

async function HeaderActions() {
  const user = await getCurrentUser();
  const isSignedIn = !!user;

  return (
    <>
      {isSignedIn ? (
        <>
          <div className="hidden md:block">
            <ModeToggle />
          </div>

          <Suspense>
            <NotificationsWrapper />
          </Suspense>

          <DropdownMenu>
            <DropdownMenuTrigger>
              <Suspense
                fallback={
                  <div className="bg-gray-800 rounded-full h-10 w-10 shrink-0 flex items-center justify-center">
                    ..
                  </div>
                }
              >
                <ProfileAvatar userId={user.id} />
              </Suspense>
            </DropdownMenuTrigger>
            <DropdownMenuContent className="space-y-2">
              <DropdownMenuItem asChild>
                <Link
                  href="/dashboard/settings"
                  className="flex gap-2 items-center cursor-pointer"
                >
                  <Settings2Icon className="w-4 h-4" /> Settings
                </Link>
              </DropdownMenuItem>
              <SignOutItem />
            </DropdownMenuContent>
          </DropdownMenu>

          <div className="md:hidden">
            <MenuButton />
          </div>
        </>
      ) : (
        <>
          <ModeToggle />

          <Button asChild variant="secondary">
            <Link href="/sign-in">Sign In</Link>
          </Button>
        </>
      )}
    </>
  );
}

export async function NotificationsWrapper() {
  const user = await getCurrentUser();

  if (!user) {
    return null;
  }

  const notifications = await getUnreadNotificationsForUserUseCase(user.id);

  return <Notifications notifications={notifications} />;
}
